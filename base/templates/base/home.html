<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JUST DO IT - To Do List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .modal {
        display: none;
        opacity: 0;
        transition: all 0.3s ease;
      }
      .modal.active {
        display: flex;
        opacity: 1;
      }
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        border-radius: 8px;
        display: none;
        color: white;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        z-index: 1000;
        max-width: 300px;
      }
      .toast.show {
        display: flex;
        align-items: center;
        gap: 10px;
        transform: translateX(0);
      }
      .toast-undo-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
      }
      .toast-undo-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
      }
      .backToTop {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 50px;
        height: 50px;
        border: none;
        border-radius: 50%;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transform: translateY(20px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease, opacity 0.3s ease, box-shadow 0.3s ease;
        z-index: 1000;
      }

      .backToTop.show {
        opacity: 1;
        transform: translateY(0);
      }

      .backToTop:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      }

      .task-card {
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }
      .task-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        transition: all 0.3s ease;
      }
      .task-card.priority-high::before {
        background: #ef4444;
      }
      .task-card.priority-mid::before {
        background: #f59e0b;
      }
      .task-card.priority-low::before {
        background: #10b981;
      }
      .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      }
      .fade-in {
        animation: fadeIn 0.3s ease-in;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .slide-up {
        animation: slideUp 0.3s ease-out;
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .priority-filter.active {
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        color: white;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        transform: scale(1.02);
      }
      .search-container {
        position: relative;
      }
      .search-input {
        padding-left: 40px;
        transition: all 0.2s ease;
      }
      .search-input:focus {
        transform: scale(1.01);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
      }
    </style>
  </head>
  <body
    class="min-h-screen bg-gradient-to-br from-gray-900 to-gray-900 text-gray-100"
  >
    <div class="flex p-4 gap-6">
      <!-- Sidebar -->
      <nav
        class="w-80 bg-gray-900/80 rounded-2xl shadow-xl p-6 flex flex-col gap-8 sticky top-4 h-[calc(100vh-2rem)] overflow-y-auto"
      >
        <header class="flex items-center">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            class="size-8"
          >
            <path
              fill-rule="evenodd"
              d="M19.916 4.626a.75.75 0 0 1 .208 1.04l-9 13.5a.75.75 0 0 1-1.154.114l-6-6a.75.75 0 0 1 1.06-1.06l5.353 5.353 8.493-12.74a.75.75 0 0 1 1.04-.207Z"
              clip-rule="evenodd"
            />
          </svg>
          <div class="ml-4">
            <h1 class="text-xl font-bold text-white">JUST DO IT</h1>
            <p class="text-sm text-gray-400">To Do List</p>
          </div>
        </header>

        <!-- Search Bar -->
        <div class="search-container">
          <input
            id="searchInput"
            type="text"
            placeholder="Search tasks..."
            class="search-input w-full p-3 rounded-xl bg-gray-800 text-white border border-gray-600 focus:outline-none focus:border-blue-500"
          />
        </div>

        <!-- Add Task -->
        <button
          id="addTaskBtn"
          class="flex items-center justify-center gap-2 px-6 py-3 text-white font-semibold rounded-xl shadow-lg bg-gradient-to-r from-blue-600 to-purple-600 hover:scale-105 transition-all duration-200 hover:shadow-xl"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            class="size-6"
          >
            <path
              fill-rule="evenodd"
              d="M12 3.75a.75.75 0 0 1 .75.75v6.75h6.75a.75.75 0 0 1 0 1.5h-6.75v6.75a.75.75 0 0 1-1.5 0v-6.75H4.5a.75.75 0 0 1 0-1.5h6.75V4.5a.75.75 0 0 1 .75-.75Z"
              clip-rule="evenodd"
            />
          </svg>
          Add New Task
        </button>

        <!-- Priorities -->
        <div>
          <h3 class="text-sm font-semibold text-gray-400 uppercase mb-3">
            Filter by Priority
          </h3>
          <ul class="flex flex-col gap-2 mb-2" id="priorityStats"></ul>
          <p class="text-xs text-gray-500 mb-3 ml-1">
            Click to filter tasks by priority level
          </p>
        </div>

        <!-- Task Completion -->
        <div
          class="mt-auto bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-xl border border-gray-600"
        >
          <h4 class="font-semibold text-white mb-2">Task Completion</h4>
          <div class="flex items-center gap-3">
            <div class="flex-1 bg-gray-700 rounded-full h-2">
              <div
                id="progressBar"
                class="bg-gradient-to-r from-green-500 to-blue-500 h-2 rounded-full transition-all duration-500"
                style="width: 0%"
              ></div>
            </div>
            <span id="progressText" class="text-sm font-semibold text-gray-300"
              >0/0</span
            >
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <main
        class="flex-1 bg-gray-900/80 rounded-2xl shadow-xl p-8 overflow-auto"
      >
        <div class="flex justify-between items-center mb-6 gap-3">
          <div>
            <h1
              class="text-3xl font-black text-white uppercase drop-shadow mb-1"
            >
              JUST DO IT.
            </h1>
            <p class="text-gray-400 text-sm">
              Organize, prioritize, and achieve your goals
            </p>
          </div>
          <div class="flex items-center gap-2">
            <select
              id="sortSelect"
              class="bg-gray-700 text-white p-2 rounded transition-all hover:bg-gray-600"
            >
              <option value="createdAt">Sort: Date Added</option>
              <option value="dueDate">Sort: Due Date</option>
              <option value="priority">Sort: Priority</option>
            </select>
            <button
              id="sortOrderBtn"
              class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-600 transition-all duration-200"
            >
              <span class="flex items-center"> ⬆ Asc </span>
            </button>
          </div>
        </div>
        <div class="grid grid-cols-3 gap-6" id="toDoBoard"></div>

        <!-- No Results Message -->
        <div id="noResults" class="hidden text-center py-12">
          <div class="text-gray-500 text-lg mb-2">No tasks found</div>
          <div class="text-gray-600 text-sm">
            Try adjusting your search or filters
          </div>
        </div>
      </main>
    </div>

    <!-- Task Modal -->
    <div
      id="taskModal"
      class="modal fixed inset-0 bg-black/60 items-center justify-center z-50"
    >
      <div class="modal-content bg-gray-800 p-6 rounded-xl w-96 mx-4">
        <h2 id="modalTitle" class="text-xl font-bold text-white mb-4">
          Add Task
        </h2>

        <div class="w-full mb-3">
          <label for="taskTitle" class="block text-gray-400 text-sm mb-1"
            >Task Title</label
          >
          <input
            id="taskTitle"
            type="text"
            class="block w-full p-2 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            placeholder="Enter task title"
            maxlength="100"
          />
        </div>

        <div class="w-full mb-3">
          <label for="taskDescription" class="block text-gray-400 text-sm mb-1"
            >Task Description</label
          >
          <textarea
            id="taskDescription"
            rows="3"
            class="block w-full p-2 rounded bg-gray-700 text-white resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            placeholder="Describe your task (optional)"
            maxlength="500"
          ></textarea>
        </div>

        <div class="w-full mb-3">
          <label for="taskStatus" class="block text-gray-400 text-sm mb-1"
            >Status</label
          >
          <select
            id="taskStatus"
            class="block w-full p-2 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
          >
            <option>Not Started</option>
            <option>In Progress</option>
            <option>Completed</option>
          </select>
        </div>

        <div class="w-full mb-3">
          <label for="taskPriority" class="block text-gray-400 text-sm mb-1"
            >Priority</label
          >
          <select
            id="taskPriority"
            class="block w-full p-2 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
          >
            <option>High</option>
            <option selected>Mid</option>
            <option>Low</option>
          </select>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-4">
          <div>
            <label for="taskDueDate" class="block text-gray-400 text-sm mb-1"
              >Due Date</label
            >
            <input
              type="date"
              id="taskDueDate"
              class="block w-full p-2 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            />
          </div>
          <div>
            <label for="taskDueTime" class="block text-gray-400 text-sm mb-1"
              >Due Time</label
            >
            <input
              type="time"
              id="taskDueTime"
              class="block w-full p-2 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            />
          </div>
        </div>

        <div class="flex justify-end gap-2">
          <button
            id="closeModal"
            class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-500 transition-all"
          >
            Cancel
          </button>
          <button
            id="saveTask"
            class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-500 transition-all"
          >
            Save Task
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div
      id="deleteModal"
      class="modal fixed inset-0 bg-black/60 items-center justify-center z-50"
    >
      <div class="modal-content bg-gray-800 p-6 rounded-xl w-80 mx-4">
        <h2 class="text-xl font-bold text-white mb-4">Confirm Delete</h2>
        <p class="text-gray-300 mb-4">
          Are you sure you want to delete this task? This action cannot be
          undone.
        </p>
        <div class="flex justify-end gap-2">
          <button
            id="cancelDeleteBtn"
            class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-500 transition-all"
          >
            Cancel
          </button>
          <button
            id="confirmDeleteBtn"
            class="px-4 py-2 bg-red-600 rounded hover:bg-red-500 transition-all"
          >
            Delete
          </button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Back to Top Button -->
    <button
      id="backToTop"
      class="backToTop"
      title="Back to top"
      aria-label="Scroll to top"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
        class="size-6"
      >
        <path
          fill-rule="evenodd"
          d="M11.47 2.47a.75.75 0 0 1 1.06 0l7.5 7.5a.75.75 0 1 1-1.06 1.06l-6.22-6.22V21a.75.75 0 0 1-1.5 0V4.81l-6.22 6.22a.75.75 0 0 1-1.06-1.06l7.5-7.5Z"
          clip-rule="evenodd"
        />
      </svg>
    </button>

    <script>
      const config = {
        columns: ["Not Started", "In Progress", "Completed"],
        priorityOrder: { High: 1, Mid: 2, Low: 3 },
        API_BASE: "http://127.0.0.1:8000/api/tasks/",
        priorities: ["High", "Mid", "Low"],
        priorityColors: {
          High: "text-red-400",
          Mid: "text-yellow-400",
          Low: "text-green-400",
        },
      };

      const DOM = {
        board: document.getElementById("toDoBoard"),
        modal: document.getElementById("taskModal"),
        deleteModal: document.getElementById("deleteModal"),
        searchInput: document.getElementById("searchInput"),
        noResults: document.getElementById("noResults"),
        backToTopBtn: document.getElementById("backToTop"),
        toast: document.getElementById("toast"),
        progressText: document.getElementById("progressText"),
        progressBar: document.getElementById("progressBar"),
        priorityStats: document.getElementById("priorityStats"),
        sortSelect: document.getElementById("sortSelect"),
        sortOrderBtn: document.getElementById("sortOrderBtn"),

        form: {
          title: document.getElementById("taskTitle"),
          description: document.getElementById("taskDescription"),
          status: document.getElementById("taskStatus"),
          priority: document.getElementById("taskPriority"),
          dueDate: document.getElementById("taskDueDate"),
          dueTime: document.getElementById("taskDueTime"),
        },

        buttons: {
          addTask: document.getElementById("addTaskBtn"),
          closeModal: document.getElementById("closeModal"),
          saveTask: document.getElementById("saveTask"),
          cancelDelete: document.getElementById("cancelDeleteBtn"),
          confirmDelete: document.getElementById("confirmDeleteBtn"),
        },

        text: {
          modalTitle: document.getElementById("modalTitle"),
        },
      };

      //states
      const state = {
        tasks: [],
        editId: null,
        taskToDelete: null,
        deletedTask: null,
        currentSearchTerm: "",
        currentPriorityFilter: null,
        sortOrder: "asc",
        searchTimeout: null,
        toastTimeout: null,
      };

      //utility functions
      const utils = {
        parseLocalDateTime: (dateTimeString) => {
          if (!dateTimeString) return null;
          const [date, time] = dateTimeString.split("T");
          const [y, m, d] = date.split("-").map(Number);
          const [h, min] = time.split(":").map(Number);
          return new Date(y, m - 1, d, h, min);
        },

        formatDueDate: (dueStr) => {
          const dateTime = utils.parseLocalDateTime(dueStr);
          if (!dateTime) return "No due date";
          return `${dateTime.toLocaleDateString(undefined, {
            year: "numeric",
            month: "short",
            day: "numeric",
          })} ${dateTime.toLocaleTimeString(undefined, {
            hour: "2-digit",
            minute: "2-digit",
          })}`;
        },

        getPriorityColor: (priorityLevel) => {
          return config.priorityColors[priorityLevel] || "";
        },
      };

      //helper function
      const helpers = {
        showToast: (
          msg,
          isError = false,
          showUndo = false,
          undoCallback = null
        ) => {
          clearTimeout(state.toastTimeout);

          DOM.toast.className = "toast show";
          DOM.toast.style.background = isError ? "#dc2626" : "#059669";

          if (showUndo && undoCallback) {
            DOM.toast.innerHTML = `
                    <span>${msg}</span>
                    <button class="toast-undo-btn" onclick="(${undoCallback.toString()})()">Undo</button>
                  `;
          } else {
            DOM.toast.textContent = msg;
          }

          state.toastTimeout = setTimeout(
            () => {
              DOM.toast.classList.remove("show");
              if (showUndo) {
                setTimeout(() => {
                  state.deletedTask = null;
                }, 300);
              }
            },
            showUndo ? 5000 : 3000
          );
        },

        matchesSearch: (task, term) => {
          if (!term) return true;
          const lower = term.toLowerCase();
          return (
            task.title.toLowerCase().includes(lower) ||
            (task.description?.toLowerCase().includes(lower) ?? false)
          );
        },

        matchesPriority: (task, priority) => {
          if (!priority) return true;
          return task.priority === priority;
        },

        filterTasks: (taskList) =>
          taskList.filter(
            (task) =>
              helpers.matchesSearch(task, state.currentSearchTerm) &&
              helpers.matchesPriority(task, state.currentPriorityFilter)
          ),

        sortTasks: (taskList, sortBy, order = "asc") => {
          const sorted = [...taskList];

          const comparators = {
            createdAt: (taskA, taskB) =>
              new Date(taskA.created_at) - new Date(taskB.created_at),
            dueDate: (taskA, taskB) =>
              new Date(taskA.due_datetime || 0) -
              new Date(taskB.due_datetime || 0),
            priority: (taskA, taskB) =>
              config.priorityOrder[taskA.priority] -
              config.priorityOrder[taskB.priority],
          };

          const compareFn = comparators[sortBy];
          if (compareFn) sorted.sort(compareFn);
          if (order === "desc") sorted.reverse();

          return sorted;
        },

        buildFilterItem: (
          label,
          count,
          color = "",
          isActive = false,
          onClick
        ) => {
          const li = document.createElement("li");
          li.className = `priority-filter flex justify-between p-3 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700 transition-all ${
            isActive ? "active" : ""
          }`;
          li.innerHTML = `<span class="${color}">${label}</span><span class="bg-gray-600 px-2 py-1 rounded-full text-xs">${count}</span>`;
          li.onclick = onClick;
          return li;
        },
      };

      //component builders
      const components = {
        createTaskCard: (task) => {
          const card = document.createElement("div");
          card.className = `task-card priority-${task.priority.toLowerCase()} p-3 bg-gray-700 rounded-lg shadow hover:scale-105 transition-all duration-200 fade-in`;
          card.dataset.id = task.id;
          card.innerHTML = `
                  <h3 class="font-semibold text-white">${task.title}</h3>
                  <p class="text-gray-300 text-xs mb-2">Date added: ${
                    utils.formatDueDate(task.created_at) || ""
                  }</p>
                  <p class="text-gray-300 text-sm">${task.description || ""}</p>
                  <p class="text-sm text-gray-400">
                    <span class="${utils.getPriorityColor(task.priority)}">${
            task.priority
          }</span> • Due: ${utils.formatDueDate(task.due_datetime)}
                  </p>
                  <div class="flex gap-2 mt-2 items-center">
                    <select onchange="api.markAsDone(${
                      task.id
                    },this.value)" class="bg-gray-600 text-white text-sm rounded p-1 transition-all hover:bg-gray-500">
                      ${config.columns
                        .map(
                          (s) =>
                            `<option ${
                              task.status === s ? "selected" : ""
                            }>${s}</option>`
                        )
                        .join("")}
                    </select>
                    <button onclick="handlers.editTask(${
                      task.id
                    })" class="p-1 text-yellow-300 hover:text-yellow-200" title="Edit">✎</button>
                    <button onclick="handlers.showDeleteModal(${
                      task.id
                    })" class="p-1 text-red-400 hover:text-red-300" title="Delete">🗑</button>
                  </div>`;
          return card;
        },

        renderColumn: (name, tasks) => {
          const colDiv = document.createElement("div");
          colDiv.className =
            "bg-gray-800 rounded-xl p-4 flex flex-col gap-3 min-h-[400px] slide-up";
          colDiv.innerHTML = `<h2 class="font-bold text-lg text-white mb-2">${name}</h2>`;
          tasks.forEach((currentTask, index) =>
            setTimeout(
              () => colDiv.appendChild(components.createTaskCard(currentTask)),
              index * 50
            )
          );
          return colDiv;
        },

        renderBoard: () => {
          DOM.board.innerHTML = "";

          const filtered = helpers.filterTasks(state.tasks);
          const sortBy = DOM.sortSelect.value;
          const sorted = helpers.sortTasks(filtered, sortBy, state.sortOrder);

          const hasTasks = sorted.length > 0;
          DOM.board.classList.toggle("hidden", !hasTasks);
          DOM.noResults.classList.toggle("hidden", hasTasks);

          if (!hasTasks) return;

          for (const col of config.columns) {
            const colTasks = sorted.filter((task) => task.status === col);
            DOM.board.appendChild(components.renderColumn(col, colTasks));
          }

          components.updateStats(filtered);
        },

        updateStats: (filteredTasks) => {
          const total = filteredTasks.length;
          const completed = filteredTasks.filter(
            (t) => t.status === "Completed"
          ).length;

          DOM.progressText.textContent = `${completed}/${total}`;
          DOM.progressBar.style.width = total
            ? (completed / total) * 100 + "%"
            : "0%";

          const counts = { All: state.tasks.length };
          config.priorities.forEach((priority) => {
            counts[priority] = state.tasks.filter(
              (t) => t.priority === priority
            ).length;
          });

          DOM.priorityStats.innerHTML = "";

          // Build filter items using configuration
          const filterConfigs = [
            {
              label: "All Tasks",
              key: "All",
              color: "",
              isActive: !state.currentPriorityFilter,
            },
            ...config.priorities.map((priority) => ({
              label: `${priority} Priority`,
              key: priority,
              color: utils.getPriorityColor(priority),
              isActive: state.currentPriorityFilter === priority,
            })),
          ];

          filterConfigs.forEach(({ label, key, color, isActive }) => {
            DOM.priorityStats.appendChild(
              helpers.buildFilterItem(
                label,
                counts[key],
                color,
                isActive,
                () => {
                  state.currentPriorityFilter = key === "All" ? null : key;
                  components.renderBoard();
                }
              )
            );
          });
        },
      };

      //api operations
      const api = {
        fetchTasks: async () => {
          try {
            state.tasks = (await axios.get(config.API_BASE)).data;
            components.renderBoard();
          } catch (e) {
            helpers.showToast("Error fetching tasks", true);
            console.error(e);
          }
        },

        getTaskFormData: () => {
          const title = DOM.form.title.value.trim();
          const description = DOM.form.description.value.trim();
          const status = DOM.form.status.value;
          const priority = DOM.form.priority.value;
          const dueDate = DOM.form.dueDate.value;
          const dueTime = DOM.form.dueTime.value;

          if (!title) {
            helpers.showToast("Enter title", true);
            return null;
          }
          if (!dueDate || !dueTime) {
            helpers.showToast("Enter due date & time", true);
            return null;
          }
          return {
            title,
            description,
            status,
            priority,
            due_datetime: `${dueDate}T${dueTime}:00`,
          };
        },

        addTask: async () => {
          const payload = api.getTaskFormData();
          if (!payload) return;

          try {
            const res = await axios.post(config.API_BASE, payload);
            if (res.status === 201) {
              state.tasks.push(res.data);
              helpers.showToast("Task added");
              modal.closeModal();
              components.renderBoard();
            }
          } catch (e) {
            helpers.showToast("Error adding task", true);
            console.error(e);
          }
        },

        updateTask: async (id) => {
          const payload = api.getTaskFormData();
          if (!payload) return;

          try {
            const res = await axios.put(`${config.API_BASE}${id}/`, payload);
            if (res.status === 200) {
              const index = state.tasks.findIndex((task) => task.id === id);
              if (index !== -1) state.tasks[index] = res.data;
              helpers.showToast("Task updated");
              state.editId = null;
              modal.closeModal();
              components.renderBoard();
            }
          } catch (e) {
            helpers.showToast("Error updating task", true);
            console.error(e);
          }
        },

        markAsDone: async (id, status) => {
          try {
            const res = await axios.patch(config.API_BASE + id + "/", {
              status,
            });
            state.tasks[
              state.tasks.findIndex((currentTask) => currentTask.id === id)
            ] = res.data;
            components.renderBoard();

            const statusMessagesDiscordDaddy = {
              "Not Started": [
                "Back to the start, kitten. Daddy's watching 😏",
                "Not started yet? Daddy believes in you… sorta 😅",
                "Fresh start, kitten. Daddy says grab a snack and go 🍕",
              ],
              "In Progress": [
                "Getting somewhere, kitten! Daddy is proud-ish 🐱",
                "Making progress! Daddy got off his chair to see this 😎",
                "Task is rolling! Don't make Daddy regret giving you mod powers 😏",
              ],
              Completed: [
                "Finally done, kitten! Daddy's proud! Treat yourself 🍩",
                "Task completed! Daddy might shed a tear 😹",
                "Well done, kitten. Daddy approves… snacks for you 🐱🎉",
              ],
              default: [
                "Status updated, kitten. Daddy sees you doing… okay 😏",
              ],
            };

            const getRandomMessageByStatus = (status) => {
              const messages =
                statusMessagesDiscordDaddy[status] ||
                statusMessagesDiscordDaddy.default;
              return messages[Math.floor(Math.random() * messages.length)];
            };

            // Usage
            let message = `Task is now ${status.toLowerCase()}. ${getRandomMessageByStatus(
              status
            )}`;
            helpers.showToast(message);
          } catch (e) {
            helpers.showToast("Error updating status", true);
            console.error(e);
          }
        },

        deleteTask: async () => {
          if (!state.taskToDelete) return;
          try {
            // Store the task before deletion for potential undo
            const taskToDelete = state.tasks.find(
              (currentTask) => currentTask.id === state.taskToDelete
            );
            state.deletedTask = { ...taskToDelete };

            await axios.delete(config.API_BASE + state.taskToDelete + "/");
            state.tasks = state.tasks.filter(
              (currentTask) => currentTask.id !== state.taskToDelete
            );
            state.taskToDelete = null;
            DOM.deleteModal.classList.remove("active");

            // Show toast with undo button
            helpers.showToast(
              "Task deleted",
              false,
              true,
              function undoDelete() {
                if (state.deletedTask) {
                  api.restoreTask(state.deletedTask);
                }
              }
            );

            components.renderBoard();
          } catch (e) {
            helpers.showToast("Error deleting task", true);
            console.error(e);
          }
        },

        restoreTask: async (taskData) => {
          if (!taskData?.id) return;

          try {
            const res = await axios.post(
              `${config.API_BASE}${taskData.id}/restore/`
            );

            if (res.status === 200 && res.data) {
              const index = state.tasks.findIndex((t) => t.id === taskData.id);
              if (index !== -1) {
                state.tasks[index] = res.data;
              } else {
                state.tasks.push(res.data);
              }

              state.deletedTask = null;

              DOM.toast.classList.remove("show");
              clearTimeout(state.toastTimeout);

              helpers.showToast("Task restored");
              components.renderBoard();
            } else {
              helpers.showToast("Failed to restore task", true);
            }
          } catch (e) {
            helpers.showToast("Error restoring task", true);
            console.error(e);
          }
        },
      };

      //modal
      const modal = {
        openModal: (isEdit) => {
          DOM.modal.classList.add("active");
          if (!isEdit) modal.resetModal();
        },

        closeModal: () => {
          DOM.modal.classList.remove("active");
          setTimeout(modal.resetModal, 300);
        },

        resetModal: () => {
          DOM.form.title.value = "";
          DOM.form.description.value = "";
          DOM.form.dueDate.value = "";
          DOM.form.dueTime.value = "";
          DOM.form.status.value = "Not Started";
          DOM.form.priority.value = "Mid";
          DOM.text.modalTitle.textContent = "Add Task";
          state.editId = null;
        },
      };

      //event handlers
      const handlers = {
        addTask: () => modal.openModal(false),
        closeModal: () => modal.closeModal(),
        saveTask: () => {
          if (state.editId) {
            api.updateTask(state.editId);
          } else {
            api.addTask();
          }
        },
        cancelDelete: () => {
          state.taskToDelete = null;
          DOM.deleteModal.classList.remove("active");
        },
        confirmDelete: () => api.deleteTask(),
        sortChange: () => components.renderBoard(),
        sortOrderToggle: () => {
          state.sortOrder = state.sortOrder === "asc" ? "desc" : "asc";
          DOM.sortOrderBtn.innerHTML = `<span class="flex items-center">${
            state.sortOrder === "asc" ? "⬆ Asc" : "⬇ Desc"
          }</span>`;
          components.renderBoard();
        },
        searchInput: (e) => {
          clearTimeout(state.searchTimeout);
          state.searchTimeout = setTimeout(() => {
            state.currentSearchTerm = e.target.value.toLowerCase();
            components.renderBoard();
          }, 300);
        },
        titleInput: (e) => {
          const r = 100 - e.target.value.length;
          e.target.style.borderColor =
            r < 20 ? (r < 0 ? "#dc2626" : "#f59e0b") : "";
        },
        scroll: () => {
          DOM.backToTopBtn.classList.toggle("show", window.scrollY > 100);
        },
        backToTop: () => {
          window.scrollTo({ top: 0, behavior: "smooth" });
        },
        editTask: (id) => {
          const task = state.tasks.find((t) => t.id === id);
          if (!task) return;
          state.editId = id;
          DOM.form.title.value = task.title;
          DOM.form.description.value = task.description || "";
          DOM.form.status.value = task.status;
          DOM.form.priority.value = task.priority;

          if (task.due_datetime) {
            const [d, t] = task.due_datetime.split("T");
            DOM.form.dueDate.value = d;
            DOM.form.dueTime.value = t?.slice(0, 5) || "";
          }

          DOM.text.modalTitle.textContent = "Edit Task";
          DOM.modal.classList.add("active");
        },
        showDeleteModal: (id) => {
          state.taskToDelete = id;
          DOM.deleteModal.classList.add("active");
        },
      };

      //event listeners
      const initializeEventListeners = () => {
        DOM.buttons.addTask.addEventListener("click", handlers.addTask);
        DOM.buttons.closeModal.addEventListener("click", handlers.closeModal);
        DOM.buttons.saveTask.addEventListener("click", handlers.saveTask);
        DOM.buttons.cancelDelete.addEventListener(
          "click",
          handlers.cancelDelete
        );
        DOM.buttons.confirmDelete.addEventListener(
          "click",
          handlers.confirmDelete
        );
        DOM.sortSelect.addEventListener("change", handlers.sortChange);
        DOM.sortOrderBtn.addEventListener("click", handlers.sortOrderToggle);
        DOM.searchInput.addEventListener("input", handlers.searchInput);
        DOM.form.title.addEventListener("input", handlers.titleInput);
        DOM.backToTopBtn.addEventListener("click", handlers.backToTop);
        window.addEventListener("scroll", handlers.scroll);
      };

      initializeEventListeners();
      api.fetchTasks();
    </script>
  </body>
</html>
