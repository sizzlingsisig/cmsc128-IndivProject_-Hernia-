{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JUST DO IT - To Do List</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Axios core + configured client -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="{% static 'js/axios.js' %}"></script>

    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .modal {
        display: none;
        opacity: 0;
        transition: all 0.3s ease;
      }
      .modal.active {
        display: flex;
        opacity: 1;
      }
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        border-radius: 8px;
        display: none;
        color: white;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        z-index: 1000;
        max-width: 300px;
      }
      .toast.show {
        display: flex;
        align-items: center;
        gap: 10px;
        transform: translateX(0);
      }
      .toast-undo-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
      }
      .toast-undo-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
      }
      .backToTop {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 50px;
        height: 50px;
        border: none;
        border-radius: 50%;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transform: translateY(20px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease, opacity 0.3s ease, box-shadow 0.3s ease;
        z-index: 1000;
      }
      .backToTop.show {
        opacity: 1;
        transform: translateY(0);
      }
      .backToTop:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      }
      .task-card {
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }
      .task-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        transition: all 0.3s ease;
      }
      .task-card.priority-high::before {
        background: #ef4444;
      }
      .task-card.priority-mid::before {
        background: #f59e0b;
      }
      .task-card.priority-low::before {
        background: #10b981;
      }
      .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      }
      .fade-in {
        animation: fadeIn 0.3s ease-in;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .slide-up {
        animation: slideUp 0.3s ease-out;
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .priority-filter.active {
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        color: white;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        transform: scale(1.02);
      }
      .search-container {
        position: relative;
      }
      .search-input {
        padding-left: 40px;
        transition: all 0.2s ease;
      }
      .search-input:focus {
        transform: scale(1.01);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
      }
      .view-btn.active {
        background: linear-gradient(135deg, #8b5cf6, #6d28d9);
      }
      .member-item {
        transition: all 0.2s ease;
      }
      .member-item:hover {
        background: rgba(75, 85, 99, 0.5);
      }
    </style>
  </head>
  <body
    class="min-h-screen bg-gradient-to-br from-gray-900 to-gray-900 text-gray-100"
  >
    <div class="flex p-4 gap-6">
      <!-- SIDEBAR -->
      <nav
        class="w-80 bg-gray-900/80 px-6 flex flex-col gap-6 h-screen overflow-y-auto sticky top-0"
      >
        <header class="flex items-center">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            class="size-8"
          >
            <path
              fill-rule="evenodd"
              d="M19.916 4.626a.75.75 0 0 1 .208 1.04l-9 13.5a.75.75 0 0 1-1.154.114l-6-6a.75.75 0 0 1 1.06-1.06l5.353 5.353 8.493-12.74a.75.75 0 0 1 1.04-.207Z"
              clip-rule="evenodd"
            />
          </svg>
          <div class="ml-4">
            <h1 class="text-xl font-bold text-white">JUST DO IT</h1>
            <p class="text-sm text-gray-400">To Do List</p>
          </div>
        </header>

        <!-- Search Bar -->
        <div class="search-container">
          <input
            id="searchInput"
            type="text"
            placeholder="Search tasks..."
            class="search-input w-full p-3 rounded-xl bg-gray-800 text-white border border-gray-600 focus:outline-none focus:border-blue-500"
          />
        </div>

        <!-- Add Task -->
        <button
          id="addTaskBtn"
          class="flex items-center justify-center gap-2 px-6 py-3 text-white font-semibold rounded-xl shadow-lg bg-gradient-to-r from-blue-600 to-purple-600 hover:scale-105 transition-all duration-200 hover:shadow-xl"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            class="size-6"
          >
            <path
              fill-rule="evenodd"
              d="M12 3.75a.75.75 0 0 1 .75.75v6.75h6.75a.75.75 0 0 1 0 1.5h-6.75v6.75a.75.75 0 0 1-1.5 0v-6.75H4.5a.75.75 0 0 1 0-1.5h6.75V4.5a.75.75 0 0 1 .75-.75Z"
              clip-rule="evenodd"
            />
          </svg>
          Add New Task
        </button>

        <!-- Priority Filters -->
        <div>
          <h3 class="text-sm font-semibold text-gray-400 uppercase mb-3">
            Filter by Priority
          </h3>
          <ul class="flex flex-col gap-2 mb-2" id="priorityStats"></ul>
          <p class="text-xs text-gray-500 mb-3 ml-1">
            Click to filter tasks by priority level
          </p>
        </div>

        <!-- Profile Button -->
        <button
          id="profileBtn"
          class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-medium transition-all"
        >
          Profile Settings
        </button>

        <!-- Completion Summary -->
        <div
          class="mt-2 bg-gradient-to-br from-gray-800 to-gray-700 p-4 rounded-xl border border-gray-600"
        >
          <h4 class="font-semibold text-white mb-2">Task Completion</h4>
          <div class="flex items-center gap-3">
            <div class="flex-1 bg-gray-700 rounded-full h-2">
              <div
                id="progressBar"
                class="bg-gradient-to-r from-green-500 to-blue-500 h-2 rounded-full transition-all duration-500"
                style="width: 0%"
              ></div>
            </div>
            <span id="progressText" class="text-sm font-semibold text-gray-300"
              >0/0</span
            >
          </div>
        </div>
      </nav>

      <!-- MAIN CONTENT -->
      <main
        class="flex-1 bg-gray-900/80 rounded-2xl shadow-xl p-8 overflow-auto"
      >
        <!-- Header with View Toggle -->
        <div class="flex justify-between items-center mb-6 gap-3">
          <div>
            <h1
              class="text-3xl font-black text-white uppercase drop-shadow mb-1"
            >
              JUST DO IT.
            </h1>
            <p class="text-gray-400 text-sm">
              Organize, prioritize, and achieve your goals
            </p>
          </div>
          <div class="flex items-center gap-2">
            <!-- View Toggle Buttons -->
            <button
              id="personalViewBtn"
              class="view-btn active px-4 py-2 rounded-lg font-semibold text-white shadow-md transition-all hover:scale-105"
            >
              Personal
            </button>
            <button
              id="collaborativeViewBtn"
              class="view-btn px-4 py-2 rounded-lg font-medium text-gray-300 bg-gray-800 shadow-md transition-all hover:scale-105"
            >
              Collaborative
            </button>

            <select
              id="sortSelect"
              class="bg-gray-700 text-white p-2 rounded transition-all hover:bg-gray-600"
            >
              <option value="createdAt">Sort: Date Added</option>
              <option value="dueDate">Sort: Due Date</option>
              <option value="priority">Sort: Priority</option>
            </select>
            <button
              id="sortOrderBtn"
              class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-600 transition-all duration-200"
            >
              <span class="flex items-center">â¬† Asc</span>
            </button>
            <button
              id="logoutBtn"
              class="text-white font-medium hover:text-red-500 cursor-pointer transition px-3 py-2"
            >
              Logout
            </button>
          </div>
        </div>

        <!-- Collaborative List Controls (Hidden by default) -->
        <div
          id="collabListControls"
          class="hidden mb-6 bg-gray-800/50 p-4 rounded-xl border border-gray-700"
        >
          <div class="flex items-center gap-3 flex-wrap">
            <select
              id="collabListDropdown"
              class="flex-1 min-w-[200px] p-2.5 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-violet-500 transition"
            >
              <option value="">Select a collaborative list...</option>
            </select>
            <button
              id="createCollabListBtn"
              class="px-4 py-2.5 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-medium transition-all shadow-md hover:scale-105"
            >
              + New List
            </button>
            <button
              id="manageCollabListBtn"
              class="px-4 py-2.5 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-medium transition-all shadow-md"
            >
              ðŸ‘¥ Manage Members
            </button>
          </div>
        </div>

        <!-- Empty State Placeholder for Collaborative Lists -->
        <div id="collabEmptyState" class="hidden text-center py-20 px-4">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="w-20 h-20 mx-auto text-gray-600 mb-4"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z"
            />
          </svg>
          <h2 class="text-2xl font-bold text-white mb-2">
            Select a Collaborative List
          </h2>
          <p class="text-gray-400 mb-6">
            Choose a list from the dropdown above to view and manage shared
            tasks with your team
          </p>
          <button
            onclick="document.getElementById('createCollabListBtn').click()"
            class="px-6 py-3 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-semibold transition-all shadow-lg hover:scale-105"
          >
            Create A Collaborative List
          </button>
        </div>

        <!-- Task Board -->
        <div class="grid grid-cols-3 gap-6" id="toDoBoard"></div>

        <div id="noResults" class="hidden text-center py-12">
          <div class="text-gray-500 text-lg mb-2">No tasks found</div>
          <div class="text-gray-600 text-sm">
            Try adjusting your search or filters
          </div>
        </div>
      </main>
    </div>

    <!-- TASK MODAL -->
    <div
      id="taskModal"
      class="modal fixed inset-0 bg-black/60 items-center justify-center z-50"
    >
      <div class="modal-content bg-gray-800 p-6 rounded-xl w-96 mx-4">
        <h2 id="modalTitle" class="text-xl font-bold text-white mb-4">
          Add Task
        </h2>
        <div class="w-full mb-3">
          <label for="taskTitle" class="block text-gray-400 text-sm mb-1"
            >Task Title</label
          >
          <input
            id="taskTitle"
            type="text"
            class="block w-full p-2 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            placeholder="Enter task title"
            maxlength="100"
          />
        </div>
        <div class="w-full mb-3">
          <label for="taskDescription" class="block text-gray-400 text-sm mb-1"
            >Task Description</label
          >
          <textarea
            id="taskDescription"
            rows="3"
            class="block w-full p-2 rounded bg-gray-700 text-white resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            placeholder="Describe your task (optional)"
            maxlength="500"
          ></textarea>
        </div>
        <div class="w-full mb-3">
          <label for="taskStatus" class="block text-gray-400 text-sm mb-1"
            >Status</label
          >
          <select
            id="taskStatus"
            class="block w-full p-2 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
          >
            <option>Not Started</option>
            <option>In Progress</option>
            <option>Completed</option>
          </select>
        </div>
        <div class="w-full mb-3">
          <label for="taskPriority" class="block text-gray-400 text-sm mb-1"
            >Priority</label
          >
          <select
            id="taskPriority"
            class="block w-full p-2 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
          >
            <option>High</option>
            <option selected>Mid</option>
            <option>Low</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-4">
          <div>
            <label for="taskDueDate" class="block text-gray-400 text-sm mb-1"
              >Due Date</label
            >
            <input
              type="date"
              id="taskDueDate"
              class="block w-full p-2 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            />
          </div>
          <div>
            <label for="taskDueTime" class="block text-gray-400 text-sm mb-1"
              >Due Time</label
            >
            <input
              type="time"
              id="taskDueTime"
              class="block w-full p-2 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            />
          </div>
        </div>
        <div class="flex justify-end gap-2">
          <button
            id="closeModal"
            class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-500 transition-all"
          >
            Cancel
          </button>
          <button
            id="saveTask"
            class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-500 transition-all"
          >
            Save Task
          </button>
        </div>
      </div>
    </div>

    <!-- DELETE MODAL -->
    <div
      id="deleteModal"
      class="modal fixed inset-0 bg-black/60 items-center justify-center z-50"
    >
      <div class="modal-content bg-gray-800 p-6 rounded-xl w-80 mx-4">
        <h2 class="text-xl font-bold text-white mb-4">Confirm Delete</h2>
        <p class="text-gray-300 mb-4">
          Are you sure you want to delete this task? This action cannot be
          undone.
        </p>
        <div class="flex justify-end gap-2">
          <button
            id="cancelDeleteBtn"
            class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-500 transition-all"
          >
            Cancel
          </button>
          <button
            id="confirmDeleteBtn"
            class="px-4 py-2 bg-red-600 rounded hover:bg-red-500 transition-all"
          >
            Delete
          </button>
        </div>
      </div>
    </div>
    <!-- SECURITY QUESTION SETUP MODAL -->
    <div
      id="securityQuestionModal"
      class="modal fixed inset-0 bg-black/60 items-center justify-center z-50"
    >
      <div
        class="bg-gray-800/80 backdrop-blur-md p-6 rounded-xl w-full max-w-md text-gray-300 fade-in"
      >
        <h2 class="text-xl font-bold mb-4">Set Security Question</h2>
        <input
          type="text"
          id="securityQuestionInput"
          placeholder="Security Question"
          class="w-full p-3 mb-3 rounded-lg bg-gray-700/80 focus:outline-none focus:ring-2 focus:ring-violet-500 transition"
          maxlength="200"
        />
        <input
          type="text"
          id="securityAnswerInput"
          placeholder="Answer"
          class="w-full p-3 mb-4 rounded-lg bg-gray-700/80 focus:outline-none focus:ring-2 focus:ring-violet-500 transition"
          maxlength="200"
        />
        <div class="flex justify-end gap-2">
          <button
            id="submitSecurityQuestion"
            class="px-4 py-2 rounded-xl text-white bg-green-500 hover:bg-green-600 shadow-md transition-colors duration-200"
          >
            Save
          </button>
        </div>
      </div>
    </div>

    <!-- COLLABORATIVE LIST MODAL -->
    <div
      id="collabListModal"
      class="modal fixed inset-0 bg-black/60 items-center justify-center z-50"
    >
      <div class="modal-content bg-gray-800 p-6 rounded-xl w-96 mx-4">
        <h2 class="text-xl font-bold text-white mb-4">
          Create Collaborative List
        </h2>
        <div class="w-full mb-4">
          <label for="collabListName" class="block text-gray-400 text-sm mb-1"
            >List Name</label
          >
          <input
            id="collabListName"
            type="text"
            class="block w-full p-2 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            placeholder="Enter list name"
          />
        </div>
        <div class="flex justify-end gap-2">
          <button
            id="closeCollabListModal"
            class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-500 transition-all"
          >
            Cancel
          </button>
          <button
            id="saveCollabList"
            class="px-4 py-2 bg-green-600 rounded hover:bg-green-500 transition-all"
          >
            Create
          </button>
        </div>
      </div>
    </div>

    <!-- MEMBER MANAGEMENT MODAL - ENHANCED -->
    <div
      id="memberModal"
      class="modal fixed inset-0 bg-black/60 items-center justify-center z-50"
    >
      <div
        class="modal-content bg-gray-800 p-6 rounded-xl w-[500px] mx-4 max-h-[80vh] overflow-y-auto"
      >
        <h2 class="text-xl font-bold text-white mb-4">Manage Members</h2>

        <!-- Current Members List -->
        <div class="mb-6">
          <h3 class="text-sm font-semibold text-gray-400 uppercase mb-3">
            Current Members
          </h3>
          <div id="membersList" class="space-y-2 max-h-60 overflow-y-auto">
            <!-- Members will be dynamically added here -->
          </div>
        </div>

        <!-- Add New Member -->
        <div class="mb-4 pt-4 border-t border-gray-700">
          <h3 class="text-sm font-semibold text-gray-400 uppercase mb-3">
            Add New Member
          </h3>
          <div class="flex gap-2">
            <input
              id="memberUsername"
              type="text"
              class="flex-1 p-2 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
              placeholder="Enter username"
            />
          </div>
        </div>

        <div class="flex justify-end">
          <div class="flex gap-2">
            <input id="memberUsername" ... />
            <button id="addMemberBtn">Add</button>
          </div>

          <div class="flex justify-end gap-2 mt-4">
            <button id="closeMemberModal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- CONFIRMATION MODAL FOR ADDING MEMBER -->
    <div
      id="confirmAddModal"
      class="modal fixed inset-0 bg-black/70 items-center justify-center z-[60]"
    >
      <div
        class="modal-content bg-gray-800 p-6 rounded-xl w-96 mx-4 border-2 border-blue-500"
      >
        <h2 class="text-xl font-bold text-white mb-4">Confirm Add Member</h2>
        <p class="text-gray-300 mb-2">
          Are you sure you want to add
          <span id="confirmUsername" class="text-blue-400 font-semibold"></span>
          to this collaborative list?
        </p>
        <p class="text-gray-400 text-sm mb-4">
          They will be able to view and edit all tasks in this list.
        </p>
        <div class="flex justify-end gap-2">
          <button
            id="cancelAddMemberBtn"
            class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-500 transition-all"
          >
            Cancel
          </button>
          <button
            id="confirmAddMemberBtn"
            class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-500 transition-all"
          >
            Add Member
          </button>
        </div>
      </div>
    </div>

    <!-- CONFIRMATION MODAL FOR REMOVING MEMBER -->
    <div
      id="confirmRemoveModal"
      class="modal fixed inset-0 bg-black/70 items-center justify-center z-[60]"
    >
      <div
        class="modal-content bg-gray-800 p-6 rounded-xl w-96 mx-4 border-2 border-red-500"
      >
        <h2 class="text-xl font-bold text-white mb-4">Confirm Remove Member</h2>
        <p class="text-gray-300 mb-2">
          Are you sure you want to remove
          <span
            id="confirmRemoveUsername"
            class="text-red-400 font-semibold"
          ></span>
          from this collaborative list?
        </p>
        <p class="text-gray-400 text-sm mb-4">
          They will lose access to all tasks in this list.
        </p>
        <div class="flex justify-end gap-2">
          <button
            id="cancelRemoveMemberBtn"
            class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-500 transition-all"
          >
            Cancel
          </button>
          <button
            id="confirmRemoveMemberBtn"
            class="px-4 py-2 bg-red-600 rounded hover:bg-red-500 transition-all"
          >
            Remove Member
          </button>
        </div>
      </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast"></div>

    <!-- BACK TO TOP -->
    <button
      id="backToTop"
      class="backToTop"
      title="Back to top"
      aria-label="Scroll to top"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
        class="size-6"
      >
        <path
          fill-rule="evenodd"
          d="M11.47 2.47a.75.75 0 0 1 1.06 0l7.5 7.5a.75.75 0 1 1-1.06 1.06l-6.22-6.22V21a.75.75 0 0 1-1.5 0V4.81l-6.22 6.22a.75.75 0 0 1-1.06-1.06l7.5-7.5Z"
          clip-rule="evenodd"
        />
      </svg>
    </button>

    <script>
      if (typeof window.apiClient === "undefined") {
        const token = localStorage.getItem("token");
        window.apiClient = axios.create({
          baseURL: "/api/",
          headers: token ? { Authorization: `Token ${token}` } : {},
        });
      }

      const config = {
        columns: ["Not Started", "In Progress", "Completed"],
        priorityOrder: { High: 1, Mid: 2, Low: 3 },
        API_BASE: "tasks/",
        COLLAB_API_BASE: "collaborative-lists/",
        priorities: ["High", "Mid", "Low"],
        priorityColors: {
          High: "text-red-400",
          Mid: "text-yellow-400",
          Low: "text-green-400",
        },
      };

      const DOM = {
        board: document.getElementById("toDoBoard"),
        modal: document.getElementById("taskModal"),
        deleteModal: document.getElementById("deleteModal"),
        collabListModal: document.getElementById("collabListModal"),
        memberModal: document.getElementById("memberModal"),
        confirmAddModal: document.getElementById("confirmAddModal"),
        confirmRemoveModal: document.getElementById("confirmRemoveModal"),
        collabEmptyState: document.getElementById("collabEmptyState"),
        searchInput: document.getElementById("searchInput"),
        noResults: document.getElementById("noResults"),
        backToTopBtn: document.getElementById("backToTop"),
        toast: document.getElementById("toast"),
        progressText: document.getElementById("progressText"),
        progressBar: document.getElementById("progressBar"),
        priorityStats: document.getElementById("priorityStats"),
        sortSelect: document.getElementById("sortSelect"),
        sortOrderBtn: document.getElementById("sortOrderBtn"),
        collabListDropdown: document.getElementById("collabListDropdown"),
        collabListControls: document.getElementById("collabListControls"),
        personalViewBtn: document.getElementById("personalViewBtn"),
        collaborativeViewBtn: document.getElementById("collaborativeViewBtn"),
        membersList: document.getElementById("membersList"),
        confirmUsername: document.getElementById("confirmUsername"),
        confirmRemoveUsername: document.getElementById("confirmRemoveUsername"),
        securityQuestionModal: document.getElementById("securityQuestionModal"),

        form: {
          title: document.getElementById("taskTitle"),
          description: document.getElementById("taskDescription"),
          status: document.getElementById("taskStatus"),
          priority: document.getElementById("taskPriority"),
          dueDate: document.getElementById("taskDueDate"),
          dueTime: document.getElementById("taskDueTime"),
          securityQuestion: document.getElementById("securityQuestionInput"),
          securityAnswer: document.getElementById("securityAnswerInput"),
        },
        collab: {
          listName: document.getElementById("collabListName"),
          memberUsername: document.getElementById("memberUsername"),
        },
        buttons: {
          addTask: document.getElementById("addTaskBtn"),
          closeModal: document.getElementById("closeModal"),
          saveTask: document.getElementById("saveTask"),
          cancelDelete: document.getElementById("cancelDeleteBtn"),
          confirmDelete: document.getElementById("confirmDeleteBtn"),
          createCollabList: document.getElementById("createCollabListBtn"),
          manageCollabList: document.getElementById("manageCollabListBtn"),
          closeCollabListModal: document.getElementById("closeCollabListModal"),
          saveCollabList: document.getElementById("saveCollabList"),
          closeMemberModal: document.getElementById("closeMemberModal"),
          addMemberBtn: document.getElementById("addMemberBtn"),
          confirmAddMemberBtn: document.getElementById("confirmAddMemberBtn"),
          cancelAddMemberBtn: document.getElementById("cancelAddMemberBtn"),
          confirmRemoveMemberBtn: document.getElementById(
            "confirmRemoveMemberBtn"
          ),
          submitSecurityQuestion: document.getElementById(
            "submitSecurityQuestion"
          ),

          cancelRemoveMemberBtn: document.getElementById(
            "cancelRemoveMemberBtn"
          ),
          profileBtn: document.getElementById("profileBtn"),
          logoutBtn: document.getElementById("logoutBtn"),
        },
        text: {
          modalTitle: document.getElementById("modalTitle"),
        },
      };

      const state = {
        tasks: [],
        currentUser: null,
        collaborativeLists: [],
        currentListMembers: [],
        pendingMemberUsername: "",
        pendingRemoveMemberUsername: "",
        editId: null,
        taskToDelete: null,
        deletedTask: null,
        currentSearchTerm: "",
        currentPriorityFilter: null,
        sortOrder: "asc",
        searchTimeout: null,
        toastTimeout: null,
        currentUserProfile: null,
        needsSecurityQuestion: false,
        currentView: localStorage.getItem("currentView") || "personal",
        selectedCollabListId:
          localStorage.getItem("selectedCollabListId") || null,
      };

      const statePersistence = {
        saveView: (view) => {
          localStorage.setItem("currentView", view);
        },

        saveSelectedList: (listId) => {
          if (listId) {
            localStorage.setItem("selectedCollabListId", listId);
          } else {
            localStorage.removeItem("selectedCollabListId");
          }
        },
      };

      const utils = {
        parseLocalDateTime: (dateTimeString) => {
          if (!dateTimeString) return null;
          const [date, time] = dateTimeString.split("T");
          const [y, m, d] = date.split("-").map(Number);
          const [h, min] = time.split(":").map(Number);
          return new Date(y, m - 1, d, h, min);
        },
        formatDueDate: (dueStr) => {
          const dateTime = utils.parseLocalDateTime(dueStr);
          if (!dateTime) return "No due date";
          return `${dateTime.toLocaleDateString(undefined, {
            year: "numeric",
            month: "short",
            day: "numeric",
          })} ${dateTime.toLocaleTimeString(undefined, {
            hour: "2-digit",
            minute: "2-digit",
          })}`;
        },
        getPriorityColor: (priorityLevel) =>
          config.priorityColors[priorityLevel] || "",
      };

      const helpers = {
        showToast: (
          msg,
          isError = false,
          showUndo = false,
          undoCallback = null
        ) => {
          clearTimeout(state.toastTimeout);
          DOM.toast.className = "toast show";
          DOM.toast.style.background = isError ? "#dc2626" : "#059669";

          if (showUndo && undoCallback) {
            DOM.toast.innerHTML = `
                    <span>${msg}</span>
                    <button class="toast-undo-btn">Undo</button>
                  `;
            const btn = DOM.toast.querySelector(".toast-undo-btn");
            btn.onclick = () => {
              undoCallback();
            };
          } else {
            DOM.toast.textContent = msg;
          }

          state.toastTimeout = setTimeout(
            () => {
              DOM.toast.classList.remove("show");
              if (showUndo) state.deletedTask = null;
            },
            showUndo ? 5000 : 3000
          );
        },

        matchesSearch: (task, term) => {
          if (!term) return true;
          const lower = term.toLowerCase();
          return (
            task.title.toLowerCase().includes(lower) ||
            (task.description || "").toLowerCase().includes(lower)
          );
        },

        matchesPriority: (task, priority) =>
          !priority || task.priority === priority,

        filterTasks: (taskList) =>
          taskList.filter(
            (task) =>
              helpers.matchesSearch(task, state.currentSearchTerm) &&
              helpers.matchesPriority(task, state.currentPriorityFilter)
          ),

        sortTasks: (taskList, sortBy, order = "asc") => {
          const sorted = [...taskList];
          const comparators = {
            createdAt: (a, b) =>
              new Date(a.created_at) - new Date(b.created_at),
            dueDate: (a, b) =>
              new Date(a.due_datetime || 0) - new Date(b.due_datetime || 0),
            priority: (a, b) =>
              config.priorityOrder[a.priority] -
              config.priorityOrder[b.priority],
          };
          const compareFn = comparators[sortBy];
          if (compareFn) sorted.sort(compareFn);
          if (order === "desc") sorted.reverse();
          return sorted;
        },

        buildFilterItem: (label, count, color, isActive, onClick) => {
          const li = document.createElement("li");
          li.className = `priority-filter flex justify-between p-3 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700 transition-all ${
            isActive ? "active" : ""
          }`;
          li.innerHTML = `<span class="${color}">${label}</span>
                                <span class="bg-gray-600 px-2 py-1 rounded-full text-xs">${count}</span>`;
          li.onclick = onClick;
          return li;
        },
      };

      const components = {
        createTaskCard: (task) => {
          const card = document.createElement("div");

          const isCollaborative = state.currentView === "collaborative";
          const creatorInfo =
            isCollaborative && task.created_by_username
              ? `<p class="text-xs text-gray-400 mb-2">Created by: <span class="text-blue-400">${task.created_by_username}</span></p>`
              : "";

          // Check if current user owns this task
          const isOwner =
            !isCollaborative || task.created_by_username === state.currentUser;

          // Show edit/delete buttons only if user is the owner
          const actionButtons = isOwner
            ? `<button onclick="handlers.editTask(${task.id})"
                    class="p-1 text-yellow-300 hover:text-yellow-200"
                    title="Edit">âœŽ</button>
             <button onclick="handlers.showDeleteModal(${task.id})"
                    class="p-1 text-red-400 hover:text-red-300"
                    title="Delete">ðŸ—‘</button>`
            : `<span class="text-xs text-gray-500 italic px-2">Read-only</span>`;

          // Show status dropdown only if user is the owner, otherwise just display status
          const statusControl = isOwner
            ? `<select class="bg-gray-600 text-white text-sm rounded p-1 transition-all hover:bg-gray-500"
                    onchange="api.markAsDone(${task.id}, this.value)">
              ${config.columns
                .map(
                  (s) =>
                    `<option ${
                      task.status === s ? "selected" : ""
                    }>${s}</option>`
                )
                .join("")}
             </select>`
            : `<span class="bg-gray-700 px-3 py-1 rounded text-sm text-gray-400 cursor-not-allowed">
               ${task.status}
             </span>`;
          const readonlyIndicator =
            !isOwner && isCollaborative
              ? "border-l-4 border-gray-600 opacity-90"
              : "";
          card.className = `task-card priority-${task.priority.toLowerCase()} p-4 bg-gray-700 rounded-lg shadow hover:shadow-xl transition-all duration-200 fade-in`;
          card.dataset.id = task.id;

          card.innerHTML = `
          <h3 class="font-semibold text-white">${task.title}</h3>
          ${creatorInfo}
          <p class="text-gray-300 text-xs mb-2">
            Date added: ${utils.formatDueDate(task.created_at)}
          </p>
          <p class="text-gray-300 text-sm">${task.description || ""}</p>
          <p class="text-sm text-gray-400">
            <span class="${utils.getPriorityColor(task.priority)}">
              ${task.priority}
            </span>
            â€¢ Due: ${utils.formatDueDate(task.due_datetime)}
          </p>
          <div class="flex gap-2 mt-2 items-center">
            ${statusControl}
            ${actionButtons}
          </div>
        `;
          return card;
        },

        renderColumn: (name, tasks) => {
          const colDiv = document.createElement("div");
          colDiv.className =
            "bg-gray-800 rounded-xl p-4 flex flex-col gap-3 min-h-[400px] slide-up";
          colDiv.innerHTML = `<h2 class="font-bold text-lg text-white mb-2">${name}</h2>`;
          tasks.forEach((t, i) =>
            setTimeout(
              () => colDiv.appendChild(components.createTaskCard(t)),
              i * 50
            )
          );
          return colDiv;
        },

        renderBoard: () => {
          DOM.board.innerHTML = "";

          // Show empty state if in collaborative view and no list selected
          if (
            state.currentView === "collaborative" &&
            !state.selectedCollabListId
          ) {
            DOM.board.classList.add("hidden");
            DOM.noResults.classList.add("hidden");
            DOM.collabEmptyState.classList.remove("hidden");
            components.updateStats([]);
            return;
          }

          DOM.collabEmptyState.classList.add("hidden");

          const filtered = helpers.filterTasks(state.tasks);
          const sortBy = DOM.sortSelect.value;
          const sorted = helpers.sortTasks(filtered, sortBy, state.sortOrder);

          const hasTasks = sorted.length > 0;
          DOM.board.classList.toggle("hidden", !hasTasks);
          DOM.noResults.classList.toggle("hidden", hasTasks);
          if (!hasTasks) {
            components.updateStats(filtered);
            return;
          }

          config.columns.forEach((col) => {
            const colTasks = sorted.filter((t) => t.status === col);
            DOM.board.appendChild(components.renderColumn(col, colTasks));
          });

          components.updateStats(filtered);
        },

        updateStats: (filteredTasks) => {
          const total = filteredTasks.length;
          const completed = filteredTasks.filter(
            (t) => t.status === "Completed"
          ).length;

          DOM.progressText.textContent = `${completed}/${total}`;
          DOM.progressBar.style.width = total
            ? (completed / total) * 100 + "%"
            : "0%";

          const counts = { All: state.tasks.length };
          config.priorities.forEach((p) => {
            counts[p] = state.tasks.filter((t) => t.priority === p).length;
          });

          DOM.priorityStats.innerHTML = "";

          const filterConfigs = [
            {
              label: "All Tasks",
              key: "All",
              color: "",
              isActive: !state.currentPriorityFilter,
            },
            ...config.priorities.map((p) => ({
              label: `${p} Priority`,
              key: p,
              color: utils.getPriorityColor(p),
              isActive: state.currentPriorityFilter === p,
            })),
          ];

          filterConfigs.forEach(({ label, key, color, isActive }) => {
            DOM.priorityStats.appendChild(
              helpers.buildFilterItem(
                label,
                counts[key],
                color,
                isActive,
                () => {
                  state.currentPriorityFilter = key === "All" ? null : key;
                  components.renderBoard();
                }
              )
            );
          });
        },

        updateViewButtons: () => {
          if (state.currentView === "personal") {
            DOM.personalViewBtn.classList.add("active");
            DOM.personalViewBtn.classList.remove("bg-gray-800");
            DOM.collaborativeViewBtn.classList.remove("active");
            DOM.collaborativeViewBtn.classList.add("bg-gray-800");

            // Hide collaborative list controls
            DOM.collabListControls.classList.add("hidden");
          } else {
            DOM.collaborativeViewBtn.classList.add("active");
            DOM.collaborativeViewBtn.classList.remove("bg-gray-800");
            DOM.personalViewBtn.classList.remove("active");
            DOM.personalViewBtn.classList.add("bg-gray-800");

            // Show collaborative list controls
            DOM.collabListControls.classList.remove("hidden");
          }
        },

        renderMembersList: () => {
          DOM.membersList.innerHTML = "";

          if (state.currentListMembers.length === 0) {
            DOM.membersList.innerHTML = `
                    <div class="text-center py-4 text-gray-400">
                      <p class="text-sm">No members yet</p>
                      <p class="text-xs mt-1">Add members using the form below</p>
                    </div>
                  `;
            return;
          }

          state.currentListMembers.forEach((member) => {
            const memberDiv = document.createElement("div");
            memberDiv.className =
              "member-item flex items-center justify-between p-3 bg-gray-700 rounded-lg";
            memberDiv.innerHTML = `
                    <div class="flex items-center gap-3">
                      <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white font-semibold text-sm">
                        ${member.charAt(0).toUpperCase()}
                      </div>
                      <span class="text-white font-medium">${member}</span>
                    </div>

                  `;
            DOM.membersList.appendChild(memberDiv);
          });
        },
      };

      const api = {
        fetchCurrentUser: async () => {
          try {
            const res = await apiClient.get("users/me/");
            state.currentUser = res.data.username;
            state.currentUserProfile = res.data;

            if (res.data.profile) {
              const hasSecurityQuestion =
                res.data.profile.security_question &&
                res.data.profile.security_question.trim() !== "";
              state.needsSecurityQuestion = !hasSecurityQuestion;

              if (state.needsSecurityQuestion) {
                DOM.securityQuestionModal.classList.add("active");
              }
            }
          } catch (e) {
            console.error("Error fetching user:", e);
            window.location.href = "/";
          }
        },
        fetchTasks: async () => {
          try {
            const viewParam =
              state.currentView === "personal" ? "personal" : "collaborative";

            let url = `${config.API_BASE}?view=${viewParam}`;

            if (
              state.currentView === "collaborative" &&
              state.selectedCollabListId
            ) {
              url += `&list_id=${state.selectedCollabListId}`;
            }

            const res = await apiClient.get(url);
            state.tasks = res.data;
            components.renderBoard();
          } catch (e) {
            helpers.showToast("Error fetching tasks", true);
            console.error(e);
          }
        },

        fetchCollaborativeLists: async () => {
          try {
            const res = await apiClient.get(config.COLLAB_API_BASE);
            state.collaborativeLists = res.data;

            DOM.collabListDropdown.innerHTML =
              '<option value="">Select a collaborative list...</option>';
            res.data.forEach((list) => {
              const option = document.createElement("option");
              option.value = list.id;
              option.textContent = list.name;
              DOM.collabListDropdown.appendChild(option);
            });

            // Restore selected list if it exists
            if (state.selectedCollabListId) {
              DOM.collabListDropdown.value = state.selectedCollabListId;
            }
          } catch (e) {
            helpers.showToast("Error loading collaborative lists", true);
            console.error(e);
          }
        },

        fetchListMembers: async (listId) => {
          try {
            const res = await apiClient.get(
              `${config.COLLAB_API_BASE}${listId}/`
            );
            state.currentListMembers = res.data.member_usernames || [];
            components.renderMembersList();
          } catch (e) {
            helpers.showToast("Error loading members", true);
            console.error(e);
          }
        },

        getTaskFormData: () => {
          const title = DOM.form.title.value.trim();
          const description = DOM.form.description.value.trim();
          const status = DOM.form.status.value;
          const priority = DOM.form.priority.value;
          const dueDate = DOM.form.dueDate.value;
          const dueTime = DOM.form.dueTime.value;

          if (!title) {
            helpers.showToast("Enter title", true);
            return null;
          }
          if (!dueDate || !dueTime) {
            helpers.showToast("Enter due date & time", true);
            return null;
          }

          const payload = {
            title,
            description,
            status,
            priority,
            due_datetime: `${dueDate}T${dueTime}:00`,
          };

          if (
            state.currentView === "collaborative" &&
            state.selectedCollabListId
          ) {
            payload.collaborative_list_id = state.selectedCollabListId;
          }

          return payload;
        },

        addTask: async () => {
          const payload = api.getTaskFormData();
          if (!payload) return;
          try {
            const res = await apiClient.post(config.API_BASE, payload);
            if (res.status === 201) {
              state.tasks.push(res.data);
              helpers.showToast("Task added");
              modal.closeModal();
              components.renderBoard();
            }
          } catch (e) {
            helpers.showToast("Error adding task", true);
            console.error(e);
          }
        },

        updateTask: async (id) => {
          const payload = api.getTaskFormData();
          if (!payload) return;
          try {
            const res = await apiClient.put(
              `${config.API_BASE}${id}/`,
              payload
            );
            if (res.status === 200) {
              const index = state.tasks.findIndex((t) => t.id === id);
              if (index !== -1) state.tasks[index] = res.data;
              helpers.showToast("Task updated");
              state.editId = null;
              modal.closeModal();
              components.renderBoard();
            }
          } catch (e) {
            helpers.showToast("Error updating task", true);
            console.error(e);
          }
        },

        markAsDone: async (id, status) => {
          try {
            const res = await apiClient.patch(`${config.API_BASE}${id}/`, {
              status,
            });
            const idx = state.tasks.findIndex((t) => t.id === id);
            if (idx !== -1) state.tasks[idx] = res.data;
            components.renderBoard();

            const statusMessages = {
              "Not Started": [
                "Back to the startâ€”fresh reset!",
                "Not started yet. You've got this.",
              ],
              "In Progress": [
                "Nice, it's moving!",
                "Progress looks goodâ€”keep going!",
              ],
              Completed: [
                "Task completed. Sweet.",
                "Done and dusted. On to the next!",
              ],
              default: ["Status updated."],
            };

            const msgs = statusMessages[status] || statusMessages["default"];
            const msg = msgs[Math.floor(Math.random() * msgs.length)];
            helpers.showToast(`Task is now ${status}. ${msg}`);
          } catch (e) {
            helpers.showToast("Error updating status", true);
            console.error(e);
          }
        },

        deleteTask: async () => {
          if (!state.taskToDelete) return;
          try {
            const taskToDelete = state.tasks.find(
              (t) => t.id === state.taskToDelete
            );
            state.deletedTask = { ...taskToDelete };

            await apiClient.delete(`${config.API_BASE}${state.taskToDelete}/`);
            state.tasks = state.tasks.filter(
              (t) => t.id !== state.taskToDelete
            );
            state.taskToDelete = null;
            DOM.deleteModal.classList.remove("active");

            helpers.showToast("Task deleted", false, true, () =>
              api.restoreTask(state.deletedTask)
            );

            components.renderBoard();
          } catch (e) {
            helpers.showToast("Error deleting task", true);
            console.error(e);
          }
        },

        restoreTask: async (taskData) => {
          if (!taskData?.id) return;
          try {
            const res = await apiClient.post(
              `${config.API_BASE}${taskData.id}/restore/`
            );
            if (res.status === 200 && res.data) {
              const idx = state.tasks.findIndex((t) => t.id === taskData.id);
              if (idx !== -1) {
                state.tasks[idx] = res.data;
              } else {
                state.tasks.push(res.data);
              }
              state.deletedTask = null;
              DOM.toast.classList.remove("show");
              clearTimeout(state.toastTimeout);
              helpers.showToast("Task restored");
              components.renderBoard();
            } else {
              helpers.showToast("Failed to restore task", true);
            }
          } catch (e) {
            helpers.showToast("Error restoring task", true);
            console.error(e);
          }
        },

        createCollaborativeList: async () => {
          const name = DOM.collab.listName.value.trim();
          if (!name) {
            helpers.showToast("Enter list name", true);
            return;
          }

          try {
            const res = await apiClient.post(config.COLLAB_API_BASE, { name });
            if (res.status === 201) {
              helpers.showToast("Collaborative list created!");
              DOM.collabListModal.classList.remove("active");
              DOM.collab.listName.value = "";
              await api.fetchCollaborativeLists();
            }
          } catch (e) {
            helpers.showToast("Error creating list", true);
            console.error(e);
          }
        },

        addMemberToList: async () => {
          const listId = DOM.collabListDropdown.value;
          if (!listId) {
            helpers.showToast("Please select a list first", true);
            return;
          }

          const username = state.pendingMemberUsername;

          try {
            await apiClient.post(
              `${config.COLLAB_API_BASE}${listId}/add_member/`,
              { username }
            );
            helpers.showToast(`Added ${username} to list!`);
            DOM.confirmAddModal.classList.remove("active");
            DOM.collab.memberUsername.value = "";
            state.pendingMemberUsername = "";
            await api.fetchListMembers(listId);
          } catch (e) {
            console.error("Error:", e);
            const errorMsg =
              e.response?.data?.error ||
              e.response?.data?.detail ||
              "User-friendly fallback message";
            helpers.showToast(errorMsg, true);
          }
        },

        removeMemberFromList: async () => {
          const listId = DOM.collabListDropdown.value;
          const username = state.pendingRemoveMemberUsername;

          try {
            await apiClient.post(
              `${config.COLLAB_API_BASE}${listId}/remove_member/`,
              { username }
            );
            helpers.showToast(`Removed ${username} from list`);
            DOM.confirmRemoveModal.classList.remove("active");
            state.pendingRemoveMemberUsername = "";
            await api.fetchListMembers(listId);
          } catch (e) {
            helpers.showToast("Error removing member", true);
            console.error(e);
            DOM.confirmRemoveModal.classList.remove("active");
          }
        },

        logout: async () => {
          try {
            await apiClient.post("users/logout/");
          } catch (_) {}
          localStorage.removeItem("token");
          helpers.showToast("Logged out");
          setTimeout(() => (window.location.href = "/"), 1000);
        },
        saveSecurityQuestion: async () => {
          const question = DOM.form.securityQuestion.value.trim();
          const answer = DOM.form.securityAnswer.value.trim();

          if (!question || !answer) {
            helpers.showToast("Please fill in both fields", true);
            return;
          }

          if (answer.length < 3) {
            helpers.showToast("Answer must be at least 3 characters", true);
            return;
          }

          try {
            await apiClient.patch("users/update-security-question/", {
              security_question: question,
              security_answer: answer,
            });

            helpers.showToast("Security question saved successfully!");
            DOM.securityQuestionModal.classList.remove("active");
            DOM.form.securityQuestion.value = "";
            DOM.form.securityAnswer.value = "";
            state.needsSecurityQuestion = false;
          } catch (e) {
            helpers.showToast("Error saving security question", true);
            console.error(e);
          }
        },
      };

      window.api = api;

      const modal = {
        openModal: (isEdit) => {
          DOM.modal.classList.add("active");
          if (!isEdit) modal.resetModal();
        },
        closeModal: () => {
          DOM.modal.classList.remove("active");
          setTimeout(modal.resetModal, 300);
        },
        resetModal: () => {
          DOM.form.title.value = "";
          DOM.form.description.value = "";
          DOM.form.dueDate.value = "";
          DOM.form.dueTime.value = "";
          DOM.form.status.value = "Not Started";
          DOM.form.priority.value = "Mid";
          DOM.text.modalTitle.textContent = "Add Task";
          state.editId = null;
        },
      };

      const handlers = {
        addTask: () => modal.openModal(false),
        closeModal: () => modal.closeModal(),
        saveTask: () => {
          if (state.editId) api.updateTask(state.editId);
          else api.addTask();
        },
        submitSecurityQuestion: () => {
          api.saveSecurityQuestion();
        },
        switchToPersonal: () => {
          state.currentView = "personal";
          state.selectedCollabListId = null;
          statePersistence.saveView("personal");
          statePersistence.saveSelectedList(null);
          components.updateViewButtons();
          api.fetchTasks();
        },

        switchToCollaborative: () => {
          state.currentView = "collaborative";
          statePersistence.saveView("collaborative");
          components.updateViewButtons();
          api.fetchCollaborativeLists();
          components.renderBoard();
        },

        collabListChange: (e) => {
          state.selectedCollabListId = e.target.value || null;
          statePersistence.saveSelectedList(state.selectedCollabListId);

          if (state.selectedCollabListId) {
            api.fetchTasks();
          } else {
            components.renderBoard();
          }
        },
        cancelDelete: () => {
          state.taskToDelete = null;
          DOM.deleteModal.classList.remove("active");
        },
        confirmDelete: () => api.deleteTask(),
        sortChange: () => components.renderBoard(),
        sortOrderToggle: () => {
          state.sortOrder = state.sortOrder === "asc" ? "desc" : "asc";
          DOM.sortOrderBtn.innerHTML = `<span class="flex items-center">${
            state.sortOrder === "asc" ? "â¬† Asc" : "â¬‡ Desc"
          }</span>`;
          components.renderBoard();
        },
        searchInput: (e) => {
          clearTimeout(state.searchTimeout);
          state.searchTimeout = setTimeout(() => {
            state.currentSearchTerm = e.target.value.toLowerCase();
            components.renderBoard();
          }, 300);
        },
        titleInput: (e) => {
          const remaining = 100 - e.target.value.length;
          e.target.style.borderColor =
            remaining < 20 ? (remaining < 0 ? "#dc2626" : "#f59e0b") : "";
        },
        scroll: () => {
          DOM.backToTopBtn.classList.toggle("show", window.scrollY > 100);
        },
        backToTop: () => {
          window.scrollTo({ top: 0, behavior: "smooth" });
        },
        editTask: (id) => {
          const task = state.tasks.find((t) => t.id === id);
          if (!task) return;
          state.editId = id;
          DOM.form.title.value = task.title;
          DOM.form.description.value = task.description || "";
          DOM.form.status.value = task.status;
          DOM.form.priority.value = task.priority;

          if (task.due_datetime) {
            const [d, t] = task.due_datetime.split("T");
            DOM.form.dueDate.value = d;
            DOM.form.dueTime.value = t ? t.slice(0, 5) : "";
          }

          DOM.text.modalTitle.textContent = "Edit Task";
          DOM.modal.classList.add("active");
        },
        showDeleteModal: (id) => {
          state.taskToDelete = id;
          DOM.deleteModal.classList.add("active");
        },
        switchToPersonal: () => {
          state.currentView = "personal";
          state.selectedCollabListId = null;
          components.updateViewButtons();
          api.fetchTasks();
        },
        switchToCollaborative: () => {
          state.currentView = "collaborative";
          components.updateViewButtons();
          api.fetchCollaborativeLists();
          components.renderBoard();
        },
        collabListChange: (e) => {
          state.selectedCollabListId = e.target.value || null;
          if (state.selectedCollabListId) {
            api.fetchTasks();
          } else {
            // Show empty state
            components.renderBoard();
          }
        },
        openCollabListModal: () => {
          DOM.collabListModal.classList.add("active");
        },
        closeCollabListModal: () => {
          DOM.collabListModal.classList.remove("active");
          DOM.collab.listName.value = "";
        },
        openMemberModal: async () => {
          const listId = DOM.collabListDropdown.value;
          if (!listId) {
            helpers.showToast("Please select a list first", true);
            return;
          }
          await api.fetchListMembers(listId);
          DOM.memberModal.classList.add("active");
        },
        closeMemberModal: () => {
          DOM.memberModal.classList.remove("active");
          DOM.collab.memberUsername.value = "";
          state.currentListMembers = [];
        },
        showAddMemberConfirm: () => {
          const username = DOM.collab.memberUsername.value.trim();
          if (!username) {
            helpers.showToast("Enter username", true);
            return;
          }

          state.pendingMemberUsername = username;
          DOM.confirmUsername.textContent = username;
          DOM.confirmAddModal.classList.add("active");
        },
        closeAddMemberConfirm: () => {
          DOM.confirmAddModal.classList.remove("active");
          state.pendingMemberUsername = "";
        },
        confirmAddMember: () => {
          api.addMemberToList();
        },
        profileRedirect: () => {
          window.location.href = "/profile";
        },
      };

      window.handlers = handlers;

      const initializeEventListeners = () => {
        DOM.buttons.addTask.addEventListener("click", handlers.addTask);
        DOM.buttons.closeModal.addEventListener("click", handlers.closeModal);
        DOM.buttons.saveTask.addEventListener("click", handlers.saveTask);
        DOM.buttons.cancelDelete.addEventListener(
          "click",
          handlers.cancelDelete
        );
        DOM.buttons.submitSecurityQuestion.addEventListener(
          "click",
          handlers.submitSecurityQuestion
        );

        DOM.buttons.confirmDelete.addEventListener(
          "click",
          handlers.confirmDelete
        );
        DOM.sortSelect.addEventListener("change", handlers.sortChange);
        DOM.sortOrderBtn.addEventListener("click", handlers.sortOrderToggle);
        DOM.searchInput.addEventListener("input", handlers.searchInput);
        DOM.form.title.addEventListener("input", handlers.titleInput);
        DOM.backToTopBtn.addEventListener("click", handlers.backToTop);
        window.addEventListener("scroll", handlers.scroll);

        DOM.personalViewBtn.addEventListener(
          "click",
          handlers.switchToPersonal
        );
        DOM.collaborativeViewBtn.addEventListener(
          "click",
          handlers.switchToCollaborative
        );
        DOM.collabListDropdown.addEventListener(
          "change",
          handlers.collabListChange
        );

        DOM.buttons.createCollabList.addEventListener(
          "click",
          handlers.openCollabListModal
        );
        DOM.buttons.closeCollabListModal.addEventListener(
          "click",
          handlers.closeCollabListModal
        );
        DOM.buttons.saveCollabList.addEventListener(
          "click",
          api.createCollaborativeList
        );
        DOM.buttons.manageCollabList.addEventListener(
          "click",
          handlers.openMemberModal
        );
        DOM.buttons.closeMemberModal.addEventListener(
          "click",
          handlers.closeMemberModal
        );

        // Member management
        DOM.buttons.addMemberBtn.addEventListener(
          "click",
          handlers.showAddMemberConfirm
        );
        DOM.buttons.confirmAddMemberBtn.addEventListener(
          "click",
          handlers.confirmAddMember
        );
        DOM.buttons.cancelAddMemberBtn.addEventListener(
          "click",
          handlers.closeAddMemberConfirm
        );
        DOM.buttons.profileBtn.addEventListener(
          "click",
          handlers.profileRedirect
        );
        DOM.buttons.logoutBtn.addEventListener("click", api.logout);
      };
      // Initialize event listeners
      initializeEventListeners();

      // Restore UI and fetch data based on persisted state
      if (state.currentView === "collaborative") {
        components.updateViewButtons();

        api.fetchCollaborativeLists().then(() => {
          if (state.selectedCollabListId) {
            DOM.collabListDropdown.value = state.selectedCollabListId;
            api.fetchTasks();
          } else {
            components.renderBoard();
          }
        });
      } else {
        components.updateViewButtons();
        api.fetchTasks();
      }

      api.fetchCurrentUser();
    </script>
  </body>
</html>
